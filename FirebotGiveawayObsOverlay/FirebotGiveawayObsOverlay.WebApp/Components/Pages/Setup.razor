@using FirebotGiveawayObsOverlay.WebApp.Helpers
@using FirebotGiveawayObsOverlay.WebApp.Models
@using FirebotGiveawayObsOverlay.WebApp.Services
@inject TimerService TimerService
@inject ThemeService ThemeService
@inject VersionService VersionService
@inject UserSettingsService UserSettingsService
@inject SettingsPersistenceService PersistenceService

@page "/setup"
@rendermode InteractiveServer

<PageTitle>Setup</PageTitle>

<h3>Setup</h3>

<hr />

<div class="mb-3">
    <label class="form-label">Theme</label>
    <div class="row">
        <div class="col-md-6">
            <label class="form-label">Preset Themes</label>
            <select class="form-select" @bind="selectedThemeName" @bind:after="OnPresetThemeChanged">
                @foreach (var theme in presetThemes)
                {
                    <option value="@theme.Name">@theme.Name</option>
                }
                <option value="Custom">Custom</option>
            </select>
        </div>
        <div class="col-md-6">
            <div class="theme-preview p-3 rounded"
                 style="background: linear-gradient(135deg, @currentTheme.BackgroundStart 0%, @currentTheme.BackgroundEnd 100%);
                        border: 2px solid @currentTheme.BorderGlowColor;
                        min-height: 80px;">
                <span style="background: linear-gradient(45deg, @currentTheme.PrimaryColor, @currentTheme.SecondaryColor);
                             -webkit-background-clip: text;
                             background-clip: text;
                             color: transparent;
                             font-weight: bold;
                             font-size: 1.2rem;">
                    Preview Text
                </span>
            </div>
        </div>
    </div>
</div>

@if (selectedThemeName == "Custom")
{
    <div class="mb-3">
        <label class="form-label">Custom Colors</label>
        <div class="card card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Primary Color</label>
                    <div class="input-group">
                        <input type="color"
                               class="form-control form-control-color"
                               @bind="customPrimaryColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                        <input type="text"
                               class="form-control"
                               @bind="customPrimaryColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Secondary Color</label>
                    <div class="input-group">
                        <input type="color"
                               class="form-control form-control-color"
                               @bind="customSecondaryColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                        <input type="text"
                               class="form-control"
                               @bind="customSecondaryColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Timer Expired Color</label>
                    <div class="input-group">
                        <input type="color"
                               class="form-control form-control-color"
                               @bind="customTimerExpiredColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                        <input type="text"
                               class="form-control"
                               @bind="customTimerExpiredColor"
                               @bind:event="onchange"
                               @bind:after="OnCustomColorChanged" />
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<hr />

<div class="mb-3">
    <label class="form-label">Countdown Timer</label>
    
    <div class="mb-3">
        <div class="form-check">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="timerEnabledCheck"
                   @bind="countdownTimerEnabled"
                   @bind:after="SetCountdownTimerEnabled" />
            <label class="form-check-label" for="timerEnabledCheck">
                Enable Countdown Timer
            </label>
        </div>
        <small class="form-text text-muted">When disabled, only entry count will be shown (file monitoring continues)</small>
    </div>
    
    <div class="d-flex gap-2">
        <div class="flex-grow-1">
            <label class="form-label">Hours</label>
            <input type="number" required
                   placeholder="Hours"
                   class="form-control"
                   min="0"
                   max="23"
                   disabled="@(!countdownTimerEnabled)"
                   @bind="countdownHours"
                   @bind:event="oninput"
                   @bind:after="SetCountdownTime" />
        </div>
        <div class="flex-grow-1">
            <label class="form-label">Minutes</label>
            <input type="number" required
                   placeholder="Minutes"
                   class="form-control"
                   min="0"
                   max="59"
                   disabled="@(!countdownTimerEnabled)"
                   @bind="countdownMinutes"
                   @bind:event="oninput"
                   @bind:after="SetCountdownTime" />
        </div>
        <div class="flex-grow-1">
            <label class="form-label">Seconds</label>
            <input type="number" required
                   placeholder="Seconds"
                   class="form-control"
                   min="0"
                   max="59"
                   disabled="@(!countdownTimerEnabled)"
                   @bind="countdownSeconds"
                   @bind:event="oninput"
                   @bind:after="SetCountdownTime" />
        </div>
    </div>
</div>

<div class="mb-3">
    <button class="btn btn-primary" 
            disabled="@(!countdownTimerEnabled)"
            @onclick="ResetGiveawayTimer">
        Reset Timer
    </button>
    <span class="ms-2 @(resetSuccess ? "text-success" : "text-danger")">@resetMessage</span>
</div>

<div class="mb-3">
    <label class="form-label">Firebot file path</label>
    <input 
        type="text" required
        placeholder="Set the path where to find the Firebot files" 
        class="form-control"
        @bind="firebotFilePath"
        @bind:event="oninput"
        @bind:after="SetFirebotFilePath" />
</div>

<div class="mb-3">
    <label class="form-label">Layout Settings</label>
    <div class="d-flex gap-2 align-items-center">
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <label class="form-label mb-0">Prize Section Width (%)</label>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button"
                            class="btn @(widthInputMode == InputMode.Slider ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="() => widthInputMode = InputMode.Slider"
                            title="Slider">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3z"/>
                        </svg>
                    </button>
                    <button type="button"
                            class="btn @(widthInputMode == InputMode.Numeric ? "btn-primary" : "btn-outline-secondary")"
                            @onclick="() => widthInputMode = InputMode.Numeric"
                            title="Numeric">
                        #
                    </button>
                </div>
            </div>
            @if (widthInputMode == InputMode.Slider)
            {
                <input type="range"
                       class="form-range"
                       min="50"
                       max="90"
                       step="5"
                       @bind="prizeSectionWidth"
                       @bind:event="oninput"
                       @bind:after="SetPrizeSectionWidth" />
            }
            else
            {
                <input type="number"
                       class="form-control"
                       min="50"
                       max="90"
                       step="5"
                       inputmode="numeric"
                       @bind="prizeSectionWidth"
                       @bind:event="onchange"
                       @bind:after="SetPrizeSectionWidthClamped" />
            }
        </div>
        <div style="width: 50px; text-align: center;">
            <span class="badge bg-primary">@prizeSectionWidth%</span>
        </div>
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Font Sizes</label>
    <div class="mb-2">
        <div class="d-flex gap-2 align-items-center">
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label mb-0">Prize Font Size</label>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button"
                                class="btn @(prizeFontInputMode == InputMode.Slider ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => prizeFontInputMode = InputMode.Slider"
                                title="Slider">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3z"/>
                            </svg>
                        </button>
                        <button type="button"
                                class="btn @(prizeFontInputMode == InputMode.Numeric ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => prizeFontInputMode = InputMode.Numeric"
                                title="Numeric">
                            #
                        </button>
                    </div>
                </div>
                @if (prizeFontInputMode == InputMode.Slider)
                {
                    <input type="range"
                           class="form-range"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           @bind="prizeFontSize"
                           @bind:event="oninput"
                           @bind:after="SetPrizeFontSize" />
                }
                else
                {
                    <input type="number"
                           class="form-control"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           inputmode="decimal"
                           @bind="prizeFontSize"
                           @bind:event="onchange"
                           @bind:after="SetPrizeFontSizeClamped" />
                }
            </div>
            <div style="width: 60px; text-align: center;">
                <span class="badge bg-primary">@prizeFontSize.ToString("0.0")rem</span>
            </div>
        </div>
    </div>

    <div class="mb-2">
        <div class="d-flex gap-2 align-items-center">
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label mb-0">Timer Font Size</label>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button"
                                class="btn @(timerFontInputMode == InputMode.Slider ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => timerFontInputMode = InputMode.Slider"
                                title="Slider">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3z"/>
                            </svg>
                        </button>
                        <button type="button"
                                class="btn @(timerFontInputMode == InputMode.Numeric ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => timerFontInputMode = InputMode.Numeric"
                                title="Numeric">
                            #
                        </button>
                    </div>
                </div>
                @if (timerFontInputMode == InputMode.Slider)
                {
                    <input type="range"
                           class="form-range"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           @bind="timerFontSize"
                           @bind:event="oninput"
                           @bind:after="SetTimerFontSize" />
                }
                else
                {
                    <input type="number"
                           class="form-control"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           inputmode="decimal"
                           @bind="timerFontSize"
                           @bind:event="onchange"
                           @bind:after="SetTimerFontSizeClamped" />
                }
            </div>
            <div style="width: 60px; text-align: center;">
                <span class="badge bg-primary">@timerFontSize.ToString("0.0")rem</span>
            </div>
        </div>
    </div>

    <div class="mb-2">
        <div class="d-flex gap-2 align-items-center">
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label mb-0">Entries Font Size</label>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button"
                                class="btn @(entriesFontInputMode == InputMode.Slider ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => entriesFontInputMode = InputMode.Slider"
                                title="Slider">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3z"/>
                            </svg>
                        </button>
                        <button type="button"
                                class="btn @(entriesFontInputMode == InputMode.Numeric ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => entriesFontInputMode = InputMode.Numeric"
                                title="Numeric">
                            #
                        </button>
                    </div>
                </div>
                @if (entriesFontInputMode == InputMode.Slider)
                {
                    <input type="range"
                           class="form-range"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           @bind="entriesFontSize"
                           @bind:event="oninput"
                           @bind:after="SetEntriesFontSize" />
                }
                else
                {
                    <input type="number"
                           class="form-control"
                           min="1.0"
                           max="6.0"
                           step="0.1"
                           inputmode="decimal"
                           @bind="entriesFontSize"
                           @bind:event="onchange"
                           @bind:after="SetEntriesFontSizeClamped" />
                }
            </div>
            <div style="width: 60px; text-align: center;">
                <span class="badge bg-primary">@entriesFontSize.ToString("0.0")rem</span>
            </div>
        </div>
    </div>
</div>

<hr />

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label mb-0">Settings Management</label>
        @if (hasCustomSettings)
        {
            <span class="badge bg-info">Custom settings active</span>
        }
        else
        {
            <span class="badge bg-secondary">Using defaults</span>
        }
    </div>

    @if (hasCustomSettings)
    {
        <div class="card border-warning">
            <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                <span class="fw-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sliders me-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/>
                    </svg>
                    Customized Settings (@settingsDiff.Count changes)
                </span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleDiffView">
                    @(showDiff ? "Hide Details" : "Show Details")
                </button>
            </div>

            @if (showDiff)
            {
                <div class="card-body p-0">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%">Setting</th>
                                <th style="width: 25%">Default</th>
                                <th style="width: 5%; text-align: center;"></th>
                                <th style="width: 25%">Current</th>
                                <th style="width: 15%; text-align: center;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var diff in settingsDiff)
                            {
                                <tr>
                                    <td class="fw-medium">@diff.Name</td>
                                    <td>
                                        @if (diff.DefaultValue.StartsWith("#"))
                                        {
                                            <span class="d-inline-flex align-items-center gap-1">
                                                <span class="color-swatch" style="background-color: @diff.DefaultValue;"></span>
                                                <code class="small">@diff.DefaultValue</code>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@diff.DefaultValue</span>
                                        }
                                    </td>
                                    <td class="text-center text-muted">→</td>
                                    <td>
                                        @if (diff.CurrentValue.StartsWith("#"))
                                        {
                                            <span class="d-inline-flex align-items-center gap-1">
                                                <span class="color-swatch" style="background-color: @diff.CurrentValue;"></span>
                                                <code class="small fw-bold">@diff.CurrentValue</code>
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="fw-bold">@diff.CurrentValue</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-secondary btn-sm py-0 px-2"
                                                title="Reset to default"
                                                @onclick="() => ResetIndividualSetting(diff.Name)">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <div class="card-footer bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Reset will restore all settings to their default values</small>
                    @if (!showResetConfirm)
                    {
                        <button class="btn btn-outline-danger btn-sm" @onclick="ShowResetConfirm">
                            Reset to Defaults
                        </button>
                    }
                    else
                    {
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary btn-sm" @onclick="CancelReset">Cancel</button>
                            <button class="btn btn-danger btn-sm" @onclick="ConfirmReset">
                                Confirm Reset
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-light border mb-0">
            <small class="text-muted">All settings are at their default values. Changes you make will be saved automatically.</small>
        </div>
    }
</div>

<hr />

<div class="mt-4 pt-2">
    <div class="d-flex justify-content-between align-items-center text-muted small">
        <span class="fw-semibold">Firebot Giveaway OBS Overlay</span>
        <span>Version <span class="badge bg-secondary">v@(versionDisplay)</span></span>
    </div>
</div>

<style>
    .color-swatch {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.2);
        vertical-align: middle;
    }
</style>

@code {
    // Input mode enum for slider/numeric toggle
    private enum InputMode { Slider, Numeric }

    private string versionDisplay = "";
    private string firebotFilePath = GiveAwayHelpers.GetFireBotFileFolder();
    private bool countdownTimerEnabled;
    private int countdownHours;
    private int countdownMinutes;
    private int countdownSeconds;
    private string resetMessage = "";
    private bool resetSuccess = false;
    private int prizeSectionWidth = GiveAwayHelpers.GetPrizeSectionWidth();
    private double prizeFontSize = GiveAwayHelpers.GetPrizeFontSize();
    private double timerFontSize = GiveAwayHelpers.GetTimerFontSize();
    private double entriesFontSize = GiveAwayHelpers.GetEntriesFontSize();

    // Input mode state for each slider setting
    private InputMode widthInputMode = InputMode.Slider;
    private InputMode prizeFontInputMode = InputMode.Slider;
    private InputMode timerFontInputMode = InputMode.Slider;
    private InputMode entriesFontInputMode = InputMode.Slider;

    // Theme-related fields
    private List<ThemeConfig> presetThemes = GiveAwayHelpers.GetAllPresetThemes();
    private ThemeConfig currentTheme = GiveAwayHelpers.GetCurrentTheme();
    private string selectedThemeName = GiveAwayHelpers.GetCurrentTheme().Name;
    private string customPrimaryColor = "#00fff9";
    private string customSecondaryColor = "#ff00c8";
    private string customTimerExpiredColor = "#ff3333";

    // Reset settings fields
    private bool hasCustomSettings = false;
    private bool showDiff = false;
    private bool showResetConfirm = false;
    private List<SettingsDiff> settingsDiff = new();

    protected override void OnInitialized()
    {
        // Initialize version display
        versionDisplay = VersionService.GetDisplayVersion();

        var (hours, minutes, seconds) = GiveAwayHelpers.GetCountdownTime();
        countdownHours = hours;
        countdownMinutes = minutes;
        countdownSeconds = seconds;
        countdownTimerEnabled = GiveAwayHelpers.GetCountdownTimerEnabled();

        // Initialize theme fields
        currentTheme = GiveAwayHelpers.GetCurrentTheme();
        selectedThemeName = GiveAwayHelpers.IsUsingCustomTheme() ? "Custom" : currentTheme.Name;
        customPrimaryColor = currentTheme.PrimaryColor;
        customSecondaryColor = currentTheme.SecondaryColor;
        customTimerExpiredColor = currentTheme.TimerExpiredColor;

        // Calculate settings diff
        UpdateSettingsDiff();
    }

    private void UpdateSettingsDiff()
    {
        var defaults = AppSettings.GetDefaults();
        var current = GiveAwayHelpers.GetCurrentSettings();
        settingsDiff = current.GetDifferences(defaults);
        hasCustomSettings = settingsDiff.Count > 0;
    }

    /// <summary>
    /// Queues settings for async persistence with debouncing.
    /// UI updates are immediate; disk writes are debounced to prevent lag.
    /// </summary>
    private void QueueSettingsSave()
    {
        PersistenceService.QueueSave(GiveAwayHelpers.GetCurrentSettings());
        UpdateSettingsDiff();
    }

    /// <summary>
    /// Legacy sync save - only used during reset operations.
    /// </summary>
    private void SaveSettingsSync()
    {
        UserSettingsService.SaveUserSettings(GiveAwayHelpers.GetCurrentSettings());
        UpdateSettingsDiff();
    }

    private void ToggleDiffView()
    {
        showDiff = !showDiff;
    }

    private void ShowResetConfirm()
    {
        showResetConfirm = true;
    }

    private void CancelReset()
    {
        showResetConfirm = false;
    }

    private void ResetIndividualSetting(string settingName)
    {
        var defaults = AppSettings.GetDefaults();

        switch (settingName)
        {
            case "Firebot File Path":
                firebotFilePath = defaults.FireBotFileFolder;
                GiveAwayHelpers.SetFireBotFileFolder(firebotFilePath);
                break;

            case "Timer Enabled":
                countdownTimerEnabled = defaults.CountdownTimerEnabled;
                GiveAwayHelpers.SetCountdownTimerEnabled(countdownTimerEnabled);
                break;

            case "Countdown Hours":
                countdownHours = defaults.CountdownHours;
                GiveAwayHelpers.SetCountdownTime(countdownHours, countdownMinutes, countdownSeconds);
                break;

            case "Countdown Minutes":
                countdownMinutes = defaults.CountdownMinutes;
                GiveAwayHelpers.SetCountdownTime(countdownHours, countdownMinutes, countdownSeconds);
                break;

            case "Countdown Seconds":
                countdownSeconds = defaults.CountdownSeconds;
                GiveAwayHelpers.SetCountdownTime(countdownHours, countdownMinutes, countdownSeconds);
                break;

            case "Prize Section Width":
                prizeSectionWidth = defaults.PrizeSectionWidthPercent;
                GiveAwayHelpers.SetPrizeSectionWidth(prizeSectionWidth);
                break;

            case "Prize Font Size":
                prizeFontSize = defaults.PrizeFontSizeRem;
                GiveAwayHelpers.SetPrizeFontSize(prizeFontSize);
                break;

            case "Timer Font Size":
                timerFontSize = defaults.TimerFontSizeRem;
                GiveAwayHelpers.SetTimerFontSize(timerFontSize);
                break;

            case "Entries Font Size":
                entriesFontSize = defaults.EntriesFontSizeRem;
                GiveAwayHelpers.SetEntriesFontSize(entriesFontSize);
                break;

            case "Theme":
                GiveAwayHelpers.SetPresetTheme(defaults.Theme.Name);
                currentTheme = GiveAwayHelpers.GetCurrentTheme();
                selectedThemeName = currentTheme.Name;
                customPrimaryColor = currentTheme.PrimaryColor;
                customSecondaryColor = currentTheme.SecondaryColor;
                customTimerExpiredColor = currentTheme.TimerExpiredColor;
                ThemeService.NotifyThemeChanged();
                break;

            case "Primary Color":
                customPrimaryColor = defaults.Theme.PrimaryColor;
                GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.PrimaryColor), customPrimaryColor);
                currentTheme = GiveAwayHelpers.GetCurrentTheme();
                ThemeService.NotifyThemeChanged();
                break;

            case "Secondary Color":
                customSecondaryColor = defaults.Theme.SecondaryColor;
                GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.SecondaryColor), customSecondaryColor);
                currentTheme = GiveAwayHelpers.GetCurrentTheme();
                ThemeService.NotifyThemeChanged();
                break;

            case "Timer Expired Color":
                customTimerExpiredColor = defaults.Theme.TimerExpiredColor;
                GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.TimerExpiredColor), customTimerExpiredColor);
                currentTheme = GiveAwayHelpers.GetCurrentTheme();
                ThemeService.NotifyThemeChanged();
                break;
        }

        QueueSettingsSave();
    }

    private void ConfirmReset()
    {
        // Delete user settings file
        UserSettingsService.DeleteUserSettings();

        // Apply default settings
        var defaults = AppSettings.GetDefaults();
        GiveAwayHelpers.ApplySettings(defaults);

        // Update local UI state
        firebotFilePath = defaults.FireBotFileFolder;
        countdownTimerEnabled = defaults.CountdownTimerEnabled;
        countdownHours = defaults.CountdownHours;
        countdownMinutes = defaults.CountdownMinutes;
        countdownSeconds = defaults.CountdownSeconds;
        prizeSectionWidth = defaults.PrizeSectionWidthPercent;
        prizeFontSize = defaults.PrizeFontSizeRem;
        timerFontSize = defaults.TimerFontSizeRem;
        entriesFontSize = defaults.EntriesFontSizeRem;

        // Update theme state
        currentTheme = GiveAwayHelpers.GetCurrentTheme();
        selectedThemeName = currentTheme.Name;
        customPrimaryColor = currentTheme.PrimaryColor;
        customSecondaryColor = currentTheme.SecondaryColor;
        customTimerExpiredColor = currentTheme.TimerExpiredColor;

        // Notify theme change
        ThemeService.NotifyThemeChanged();

        // Reset UI state
        showResetConfirm = false;
        showDiff = false;
        UpdateSettingsDiff();
    }

    private void SetFirebotFilePath()
    {
        GiveAwayHelpers.SetFireBotFileFolder(firebotFilePath);
        QueueSettingsSave();
    }

    private void SetCountdownTime()
    {
        GiveAwayHelpers.SetCountdownTime(countdownHours, countdownMinutes, countdownSeconds);
        QueueSettingsSave();
    }

    private void SetCountdownTimerEnabled()
    {
        bool wasEnabled = GiveAwayHelpers.GetCountdownTimerEnabled();
        GiveAwayHelpers.SetCountdownTimerEnabled(countdownTimerEnabled);

        // If timer was disabled, stop the current timer
        if (wasEnabled && !countdownTimerEnabled)
        {
            // Timer will be stopped automatically by the GiveAway component when it detects the setting change
        }
        // If timer was enabled, reset the timer
        else if (!wasEnabled && countdownTimerEnabled)
        {
            TimerService.ResetTimer();
        }

        QueueSettingsSave();
    }

    private void ResetGiveawayTimer()
    {
        // Only reset if timer is enabled
        if (!countdownTimerEnabled)
        {
            resetMessage = "Timer is disabled";
            resetSuccess = false;
            return;
        }
        
        try
        {
            TimerService.ResetTimer();
            resetMessage = "Timer reset successfully!";
            resetSuccess = true;
        }
        catch (Exception ex)
        {
            resetMessage = $"Error: {ex.Message}";
            resetSuccess = false;
        }
    }

    private void SetPrizeSectionWidth()
    {
        GiveAwayHelpers.SetPrizeSectionWidth(prizeSectionWidth);
        QueueSettingsSave();
    }

    private void SetPrizeSectionWidthClamped()
    {
        prizeSectionWidth = Math.Clamp(prizeSectionWidth, 50, 90);
        SetPrizeSectionWidth();
    }

    private void SetPrizeFontSize()
    {
        GiveAwayHelpers.SetPrizeFontSize(prizeFontSize);
        QueueSettingsSave();
    }

    private void SetPrizeFontSizeClamped()
    {
        prizeFontSize = Math.Clamp(prizeFontSize, 1.0, 6.0);
        SetPrizeFontSize();
    }

    private void SetTimerFontSize()
    {
        GiveAwayHelpers.SetTimerFontSize(timerFontSize);
        QueueSettingsSave();
    }

    private void SetTimerFontSizeClamped()
    {
        timerFontSize = Math.Clamp(timerFontSize, 1.0, 6.0);
        SetTimerFontSize();
    }

    private void SetEntriesFontSize()
    {
        GiveAwayHelpers.SetEntriesFontSize(entriesFontSize);
        QueueSettingsSave();
    }

    private void SetEntriesFontSizeClamped()
    {
        entriesFontSize = Math.Clamp(entriesFontSize, 1.0, 6.0);
        SetEntriesFontSize();
    }

    private void OnPresetThemeChanged()
    {
        if (selectedThemeName == "Custom")
        {
            // When switching to Custom, apply current custom colors
            GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.PrimaryColor), customPrimaryColor);
            GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.SecondaryColor), customSecondaryColor);
            GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.TimerExpiredColor), customTimerExpiredColor);
            currentTheme = GiveAwayHelpers.GetCurrentTheme();
        }
        else
        {
            GiveAwayHelpers.SetPresetTheme(selectedThemeName);
            currentTheme = GiveAwayHelpers.GetCurrentTheme();
            customPrimaryColor = currentTheme.PrimaryColor;
            customSecondaryColor = currentTheme.SecondaryColor;
            customTimerExpiredColor = currentTheme.TimerExpiredColor;
        }
        ThemeService.NotifyThemeChanged();
        QueueSettingsSave();
    }

    private void OnCustomColorChanged()
    {
        selectedThemeName = "Custom";
        GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.PrimaryColor), customPrimaryColor);
        GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.SecondaryColor), customSecondaryColor);
        GiveAwayHelpers.UpdateCustomColor(nameof(ThemeConfig.TimerExpiredColor), customTimerExpiredColor);
        currentTheme = GiveAwayHelpers.GetCurrentTheme();
        ThemeService.NotifyThemeChanged();
        QueueSettingsSave();
    }
}
